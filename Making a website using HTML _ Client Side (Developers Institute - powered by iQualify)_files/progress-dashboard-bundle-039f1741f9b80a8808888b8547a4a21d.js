!function(){function e(e,r,s,i,a,t,n,o,u,c,d,l,f,m,g,k,v,p,b,h,M,S){function A(){t.get(y,function(e){r.assessments=e.assessments,c.submissions=e.submissions,r.practices=e.practices,r.hasPractices=Object.keys(e.practices||{}).length>0})}var w=i.userId||g;w||(w=k.learnerId),M&&M.orgSettings&&M.orgSettings.groupAssessmentsEnabled&&(r.groupAssessmentsEnabled=M.orgSettings.groupAssessmentsEnabled),r.progressMode=k.isGuest?"guest":"learner",r.learnerMode="learner"===r.progressMode,r.guestMode="guest"===r.progressMode,r.facilitatorDashboardMode=r.userService&&r.userService.isFacilitatorOfOffering(d.id)&&b.path().indexOf("facilitator-dashboard")>-1,r.showGuestEmailValidationModal=!1,r.isFacilitator=!1,r.isEvaluator=!1,r.userService&&(r.isFacilitator=r.userService.isFacilitatorOfOffering(d.id),r.isEvaluator=r.contentService.isEvaluatorOfOffering()),r.answeredPulseId=i.answeredpulse,r.userId=w,r.offering=d,r.ctrl=r,r.ctrl.ctrlName="facilitatorDashboardView",r.submissionsService=c,r.currentBadge,r.modals={},r.learnerTab=r.learnerTab||"learner-assessments",r.allowTasks=p.get(r.contentService.offering,"settings.allowTasks",!1),r.viewAssessment=function(e,s){r.submissionsService.viewAssessment(r,e,s,function(){r.getFocusTargets()})},r.getFocusTargets=function(e){$(".modal-dialog").size()?h(function(){$(".modal-header button.close")[0].focus()},1e3):window.requestAnimationFrame(r.getFocusTargets)},r.topTabSetActiveIndex=0,r.pulseRender=!0,r.getBadgeLandingPageUrl=function(e){var r=m.iqfy.badgesUrl+"/badges/"+e;return s.trustAsResourceUrl(r)},r.isOpenBadge=function(e){return e&&e.openBadge},r.isRevokedBadge=function(e){return e&&e.revoked},r.containOpenBadgeAssertion=function(e){return e&&e.openBadge&&e.openBadge.assertion},r.getBadgeClassImageUrl=function(e){var r=((e.openBadge||{}).badge||{}).image;if(r)return s.trustAsResourceUrl(r)},r.getBadgeImageUrl=function(e,i){var a=r.isOpenBadge(e),t=((e.openBadge||{}).assertion||{}).image,n=e.imageUrl,o=a?t:n;return a&&i&&(o+="?download=1"),s.trustAsResourceUrl(o)},r.showMarkedItems=!0,r.graphPulse={id:null},r.timezone="Pacific/Auckland",M&&M.orgSettings&&M.orgSettings.timezone&&(r.timezone=M.orgSettings.timezone),r.redactorConfiguration={buttons:["bold","italic","link"]},r.isLearnerAssessmentVisible=function(e,r){return!0},r.goBack=function(){m.history.back()},r.$root.$on("modalClosed",function(e,s){r.progress=r.progress||{},r.progress.playlist=r.progress.playlist||{},r.progress.playlist[s.key]=r.progress.playlist[s.key]||{},r.modals={},r.$digest()}),r.barChartOptions={scales:{yAxes:[{ticks:{beginAtZero:!0}}]}},r.newGuest={},r.validateFeedbackForm=function(){var s=r.submissionsService.newMarkerEval;return void 0===s||!s.mark&&!s.feedback?(r.submissionsService.feedbackFormErrorMessage=e.t("PleaseLeaveMarkOrFeedback"),!1):(r.submissionsService.feedbackFormErrorMessage="",!0)},r.isShowEvaluationFeedbackPanel=function(e){return!e.isArchived&&(r.isShowEvaluationFeedbackForm(e)||e.markFeedback)},r.isShowEvaluationFeedbackForm=function(e){if(!r.userService)return!1;var s=r.userService._details.uid,i=!1;return e.markFeedback&&(i=!0),!i&&r.isFacilitator&&e&&e.markerId!==s},"serviceWorker"in navigator&&r.guestMode&&navigator.serviceWorker.getRegistrations().then(function(e){e.forEach(function(e){e.unregister()})});var F=function(s,i){s&&f.get({offeringid:r.offering.id,pulseid:s},function(s){r.pulseResponses=s.data;var a,t,n;r.stackedBarGraphData=[],r.stackedBarGraphSeries=[],r.lineGraphSeries=[e.t("AverageAnswerChoice")],p.each(r.pulses,function(e,s){a=s;var i;if("submit_text"===e.category&&e.instances&&(r.graphPulseLabels[a]=[],r.graphPulseData[a]=[],i=0,p.each(e.instances,function(e,s){t=moment(e.createdAt).format("L"),r.graphPulseLabels[a][i]=t,r.pulseResponses[a]&&(r.graphPulseData[a][i]=r.pulseResponses[a][s]),i++})),"MCQ"===e.category){e.instances&&(r.graphPulseLabels[a]=[],r.graphPulseData[a]=[[]]),e.scale||(r.stackedBarGraphData[a]=[],r.stackedBarGraphSeries[a]=[],p.each(e.options,function(e,s){r.stackedBarGraphData[a].push([]),r.stackedBarGraphSeries[a].push(e.html)}),p.each(r.stackedBarGraphData[a],function(s,i){r.stackedBarGraphData[a][i]=[],p.each(e.instances,function(e){r.stackedBarGraphData[a][i].push(0)})})),i=0;var o=!1;p.each(e.instances,function(s,u){if(t=moment(s.createdAt).format("L"),r.graphPulseLabels[a][i]=t,e.scale&&(r.graphPulseData[a][0][i]=0),void 0!==r.pulseResponses[a]&&void 0!==r.pulseResponses[a][u]){o=!0;var c=1;p.each(r.pulseResponses[a][u],function(s){e.scale?(r.graphPulseData[a][0][i]+=parseInt(s.answer),c===p.size(r.pulseResponses[a][u])&&(r.graphPulseData[a][0][i]=r.graphPulseData[a][0][i]/c),c++):(n=parseInt(s.answer),r.stackedBarGraphData[a][n][i]+=1)})}else r.graphPulseData[a][0][i]=null;i++}),o||r.graphPulseData[a]&&(r.graphPulseData[a][0]=null)}"spatial"===e.category&&(e.instances&&(r.graphPulseLabels[a]=[],"planar"===e.subcategory?r.graphPulseData[a]=[[[]]]:r.graphPulseData[a]=[[[{}]]]),i=0,p.each(e.instances,function(e,s){t=moment(e.createdAt).format("L"),r.graphPulseLabels[a][i]=t,void 0!==r.pulseResponses[a]&&void 0!==r.pulseResponses[a][s]&&p.each(r.pulseResponses[a][s],function(e,s){r.graphPulseData[a][i]=r.graphPulseData[a][i]||[],r.graphPulseData[a][i][0]=r.graphPulseData[a][i][0]||[],r.graphPulseData[a][i][1]=r.graphPulseData[a][i][1]||[];var t=s==g?0:1;r.graphPulseData[a][i][t]=r.graphPulseData[a][i][t]||[],r.graphPulseData[a][i][t].push(e.answer)}),i++}))}),i&&i()})};r.graphPulseLabels={},r.graphPulseData={},r.guestMode||l.get({offeringid:r.offering.id},function(e){r.pulses=e.data;var s=[];p.each(r.pulses,function(e,r){e.instances&&e.instances[e.latestInstanceKey]&&e.instances[e.latestInstanceKey].createdAt&&(e.latestInstanceCreatedAt=e.instances[e.latestInstanceKey].createdAt,s.push({title:e.title,lastRun:e.latestInstanceCreatedAt,key:r}))}),r.pulsesDropdown=s,s.length&&h(function(){r.graphPulse.id=r.populatePulseDropdown(),r.viewGraph()})}),r.populatePulseDropdown=function(){return r.answeredPulseId?r.answeredPulseId:p.sortBy(r.pulsesDropdown,"lastRun").reverse()[0].key},r.viewGraph=function(){r.pulseRender=!1,r.pulseLoading=!0,h(function(){F(r.graphPulse.id,function(){r.pulseLoading=!1,r.pulseRender=!0})})};var y={learnerid:w};k.token&&(y.token=k.token),r.onUploadMarkingFile=function(e){r.submissionsService.onUploadMarkingFile(e,r)},r.isBadgeExists=function(){return!!(r.progress&&r.progress.badges&&Object.keys(r.progress.badges).length>0)},r.activeLearnerTab=function(e){r.learnerTab=e},a.get(y,function(s){if(1!=s.askForEmail)r.learner=s,r.learner.uid=w,a.get(p.extend({},y,{info:"progress"}),function(e){if(r.progress=e,e.mostActiveInitial){var s=moment.utc().set("hour",e.mostActiveInitial).valueOf(),i=moment(s).tz(r.timezone),a=moment(i).tz(r.timezone).format("h"),t=moment(i).add(1,"hour"),n=t.tz(r.timezone).format("h"),o=t.tz(r.timezone).format("a");r.progress.mostActive=a+"-"+n+o}else r.noProgress=!0},function(){S.error(e.t("ErrorLoadingProgressScreenTryAgainLater"))}),r.toggleBadge=function(e){var s=e.$key;e.isCollapsed=!e.isCollapsed,r.currentBadge===s?r.currentBadge=null:r.currentBadge=s},A();else{v.open({size:"lg",templateUrl:"/ng-assets/app/templates/Learn/guest_email_modal.html",controller:"GuestEmailValidationModalController",resolve:{user:function(){return s.user},guest:function(){return s.guest}}})}})}e.$inject=["$i18next","$scope","$sce","$routeParams","FacilitatorDashboardUserAPI","FacilitatorDashboardUserSubmissionsAPI","FacilitatorDashboardQuizAttemptAPI","FacilitatorDashboardAssignmentSubmissionAPI","FacilitatorAssignmentMarkAPI","FacilitatorSubmissionsService","offering","PulseActivityAPI","PulseActivityResponseAPI","$window","currentUserId","guest","$uibModal","_","$location","$timeout","iqfy","toastr"],angular.module("iqfy").controller("facilitatorDashboardView",e)}(),function(){angular.module("iqfy").controller("facilitatorDashboardIndex",["$i18next","$scope","$rootScope","$timeout","$uibModal","FacilitatorDashboardUserAPI","FacilitatorDashboardOfferingSubmissionsAPI","FacilitatorSubmissionsService","EvaluatorSubmissionsService","MarkerSubmissionsService","CourseHomeService","OfferingsDataService","EvaluatorAPI","MarkerAPI","OfferingsUsersAPI","offering","$location","$window","guest","vocab","iqfy","toastr","$sce",function(e,r,s,i,a,t,n,o,u,c,d,l,f,m,g,k,v,p,b,h,M,S,A){function w(s){t.query(function(e){l.learners=_.filter(e,{isFacilitator:!1,isMarker:!1}),r.learners=l.learners,_.forEach(r.learners,function(e){if("number"==typeof e.lastOfferingAccessDate)e.lastOfferingAccessTimestamp=e.lastOfferingAccessDate;else{var r=new Date(e.lastOfferingAccessDate).getTime();isNaN(r)?e.lastOfferingAccessTimestamp=0:e.lastOfferingAccessTimestamp=r}}),r.learnersCount=_.size(r.learners),r.facilitators=_.filter(e,function(e,s){return e.isFacilitator&&e.uid!==r.userService._details.uid}),l.facilitators=_.filter(e,{isFacilitator:!0}),r.markers=_.filter(e,{isMarker:!0}),l.markers=_.cloneDeep(r.markers),r.markersCount=_.size(r.markers),r.facilitatorsCount=_.size(r.facilitators)+1,l.markedLearners=s||_.get(r.contentService.offering,"marker_learners",{}),l.resetUserChanges()},function(r){S.error(e.t("SomethingWentWrongFetchingProgressLearners"))})}function F(){r.contentService&&r.contentService.offering&&r.contentService.offering.start&&(r.startDate=moment(r.contentService.offering.start).tz(y).format("DD MMMM YYYY")),r.contentService&&r.contentService.offering&&r.contentService.offering.end&&(r.endDate=moment(r.contentService.offering.end).tz(y).format("DD MMMM YYYY"))}r.vocab=h,r.predicate="first",r.reverse=!1,r.ctrl=r,r.ctrl.ctrlName="facilitatorDashboardIndex",r.offering=k,r.isFacilitator=!1,r.isEvaluator=!1,r.isMarker=!1,r._=_,r.visibleLearnerCount=5,r.$sce=A,r.hasPulses=!0,r.allowTasks=_.get(r.contentService.offering,"settings.allowTasks",!1);var y="Pacific/Auckland";M&&M.orgSettings&&M.orgSettings.timezone&&(y=M.orgSettings.timezone),F(),r.incrementVisibleLearners=function(){r.visibleLearnerCount+=5},M&&M.orgSettings&&M.orgSettings.groupAssessmentsEnabled&&(r.groupAssessmentsEnabled=M.orgSettings.groupAssessmentsEnabled||!1),r.showMarkedItems=!0,r.toggleShowMarkedItems=function(){r.showMarkedItems=!r.showMarkedItems},r.progressMode=b.isGuest?"guest":"learner",r.learnerMode="learner"===r.progressMode;var D=_.get(r.contentService,"offering.mainFacilitators",{}),P=_.get(M,"orgSettings.allowAutomaticCourseActivation",!1);if(r.userService){r.isFacilitator=r.userService.isFacilitatorOfOffering(k.id),r.isEvaluator=r.contentService.isEvaluatorOfOffering(),r.isMarker=r.contentService.isMarkerOfOffering(),r.feedbackMarkingMode=v.path().indexOf("class")>-1,r.isFacilitator?(r.facilitatorDashboardMode=v.path().indexOf("facilitator-dashboard")>-1,r.feedbackMarkingMode=!0,r.isMainFacilitator=_.findEnabledKeys(D).includes(r.userService._details.uid),r.allowAutomaticCourseActivation=P&&r.isMainFacilitator,r.submissionsService=o):r.isEvaluator?(r.evaluatorDashboardMode=!0,r.feedbackMarkingMode&&(r.learnerMode=!1),r.submissionsService=u):r.isMarker&&(r.markerDashboardMode=!0,r.learnerMode=!1,r.submissionsService=c),r.displayUserPresence=M.isPubNubFeatureOn&&(r.isFacilitator||r.markerDashboardMode);if(!(r.isFacilitator||r.isEvaluator||r.isMarker))return function(){window.location.hash="#/overview"}()}r.submissionsService&&(r.submissionsService.showAmendFeedbackForMark=!1);var I=(r.contentService.offering||{}).facilitators||[],E=function(e){return _.filter(e,function(e){return-1===I.indexOf(e.uid)})};r.userService&&(r.isFacilitator?(w(),n.get({},function(e){r.assessments=e.assessments,o.submissions=e.submissions}),d.getProgress(r.contentService.offering.id,r.userService._details.uid).toPromise().then(function(e){r.progress=e})):r.isEvaluator?(f.query({action:"evaluatees"},function(e){r.learners=E(e),r.learnersCount=_.size(r.learners)},function(r){S.error(e.t("SomethingWentWrongFetchingProgressLearners"))}),f.get({action:"submissions"},function(e){r.assessments=e.assessments,r.submissionsService.submissions=e.submissions},function(r){S.error(e.t("SomethingWentWrongFetchingAssessmentSubmissionsLearners"))})):r.isMarker&&(m.query({action:"markedLearners"},function(e){r.learners=E(e),r.learnersCount=_.size(r.learners)},function(r){S.error(e.t("SomethingWentWrongFetchingProgressLearners"))}),m.get({action:"submissions"},function(e){r.assessments=e.assessments,r.submissionsService.submissions=e.submissions},function(r){S.error(e.t("SomethingWentWrongFetchingAssessmentSubmissionsLearners"))}))),r.order=function(e,s){"name"==e?"first"!=r.predicate&&"last"!=r.predicate?(r.predicate="first",r.reverse=!1):"first"==r.predicate?r.reverse?(r.predicate="last",r.reverse=!r.reverse):r.reverse=!0:r.reverse?(r.predicate="first",r.reverse=!r.reverse):r.reverse=!0:(r.predicate=e,r.reverse=r.predicate===e&&!r.reverse)},r.isLearnerAssessmentVisible=function(e,s){if("upload"==e.type||"openResponse"==e.type||"externalProvider"===e.type){if(r.isMarker&&!0!==e.mentors)return!1;if(r.isEvaluator&&!0!==e.peerEvaluators)return!1}return!!r.showMarkedItems||void 0===r.submissionsService.getFormattedMark(s,e)},r.isLearnerVisible=function(e){return!!r.showMarkedItems||!r.submissionsService.hasUnmarkedAssessmentItem(e,r.assessments)},r.viewAssessment=function(e,s){r.submissionsService.viewAssessment(r,e,s,function(){r.getFocusTargets()})},r.getFocusTargets=function(e){$(".modal-dialog").size()?i(function(){$(".modal-header button.close")[0].focus()},1e3):window.requestAnimationFrame(r.getFocusTargets)},r.modals={};var z=function(){i(function(){r.modals={},r.submissionsService.newMarkerEval={},$("body").removeClass("modal-open"),$(".modal-backdrop").hide()})};angular.element(document).on("keyup",function(e){27===e.which&&z()}),s.$on("modalClosed",function(e,r){z()}),r.isShowEvaluationFeedbackPanel=function(e){return r.isShowEvaluationFeedbackForm(e)||e.markFeedback},r.clearMarkFeedback=function(){if(r.switchTab){if(!(r.submissionsService&&r.submissionsService.newMarkerEval))return;var e=r.submissionsService.newMarkerEval.mark||"",s=r.submissionsService.newMarkerEval.feedback||"";(e||s)&&(e&&delete r.submissionsService.newMarkerEval.mark,s&&delete r.submissionsService.newMarkerEval.feedback)}},r.switchTabs=function(s){if(r.switchTab=!1,p.testsAreRunning)return void(r.switchTab=!0);if(r.submissionsService.newMarkerEval&&(r.submissionsService.newMarkerEval.mark||r.submissionsService.newMarkerEval.feedback)){if(p.confirm(e.t("AreYouSure?")))return void(r.switchTab=!0);s.preventDefault()}},r.offerConfirmModalClose=function(){return!!r.submissionsService.newMarkerEval&&!(!r.submissionsService.newMarkerEval.mark&&!r.submissionsService.newMarkerEval.feedback)},r.isShowEvaluationFeedbackForm=function(e){if(!r.userService)return!1;var s=r.userService._details.uid,i=!1;return e.markFeedback&&(i=!0),!(i||!(r.isMarker&&r.contentService.isMarkerOfUser(e.markerId)||r.isFacilitator)||!e||e.markerId===s)},r.isShowEvaluationAmendFeedbackButton=function(e,s){if(!r.userService)return!1;var i=r.userService._details.uid,a=!1;return e&&(a=!0),!!(a&&(r.isMarker&&r.contentService.isMarkerOfUser(s.markerId)||r.isFacilitator)&&e&&e.markerId===i)},r.isShowEvaluationAmendFeedbackForm=function(e){r.submissionsService.showAmendFeedbackForMark=e.markerId},r.hideAmendFeedbackForm=function(){r.submissionsService.showAmendFeedbackForMark=!1},r.goToOffering=function(e){p.location="/marking/"+e+"#/facilitator-dashboard/users/"},r.validateFeedbackForm=function(){var s=r.submissionsService.newMarkerEval;return void 0===s||!s.mark&&!s.feedback?(r.submissionsService.feedbackFormErrorMessage=e.t("PleaseLeaveMarkOrFeedback"),!1):(r.submissionsService.feedbackFormErrorMessage="",!0)},r.onUploadMarkingFile=function(e){r.submissionsService.onUploadMarkingFile(e,r)},r.onDeleteMarkingFile=function(e){r.submissionsService.onDeleteMarkingFile(e)},r.hasBadges=function(){return r.progress&&r.progress.badges&&!!_.size(r.progress.badges)},r.onPulsesChange=function(e){r.hasPulses=0!==_.size(e)},r.showAddSingleUserModal=function(e){a.open({size:"lg",templateUrl:"OfferingsUserModalTemplate",controller:"OfferingsUserModalController",resolve:{offeringId:function(){return k.id},userType:function(){return e},createMode:function(){return!1},editType:function(){return"add"},user:function(){return null},userAccess:function(){return"facilitateMode"}}}).result.then(function(){w()})},r.showEditDatesModal=function(){a.open({size:"lg",templateUrl:"/ng-assets/app/templates/Learn/offering_dates_modal.html",controller:"OfferingDatesModalController",keyboard:!1,resolve:{offering:function(){return _.get(r.contentService,"offering",{})}}}).result.then(function(e){e&&e.updated&&F()})},r.redactorConfiguration={buttons:["bold","italic","link"]},r.removeLearnerFromCourse=function(r,s){if(window.confirm(e.t("AreYouSureYouWantRemoveLearner"))){l.removeUser("learners",r,s);var i={};i.user={changes:l.changes},g.processUserUpdates(k.id,!0).save({offeringData:i},function(r){S.success(e.t("UserHasBeenRemoved"));var s=_.find(r,{type:"response"});w(_.get(s,"response.marker_learners",{}))},function(){S.error(e.t("SomethingWentWrong"))})}},r.onRemoveTag=function(r){var s=r.isFacilitator?"facilitators":"markers";l.removeUser(s,r.email,r.uid);var i={};i.user={changes:l.changes},g.processUserUpdates(k.id).save({offeringData:i},function(r){S.success(e.t("UserHasBeenRemoved")),w()},function(){S.error(e.t("SomethingWentWrong"))})},r.showMarkerModal=function(r){a.open({animation:!0,templateUrl:"/ng-assets/app/templates/includes/MarkerSettingsModalTemplate.html",controller:"MarkerSettingsModalController",size:"md",resolve:{mode:function(){return"facilitateMode"},user:r}}).result.then(function(r){var s=(_.get(l,"changes.learners.markers",{}),{});s.user={changes:l.changes},g.processUserUpdates(k.id).save({offeringData:s},function(e){var r=_.find(e,{type:"response"});w(_.get(r,"response.marker_learners",{}))},function(){S.error(e.t("SomethingWentWrong"))})})}}])}(),function(){"use strict";angular.module("iqfy").controller("GuestEmailValidationModalController",["$scope","$uibModalInstance","_","$window","user","guest","FacilitatorDashboardUserAPI",function(e,r,s,i,a,t,n){e.user=a,e.guest=t,e.ok=function(){var s={learnerid:a.learnerId,token:t.token,email:e.email};n.get(s,function(s){0==s.emailVerified?e.nonVerifiedEmail=!0:(r.close(),window.location.reload(!0))})},e.cancel=function(){r.dismiss("cancel")}}])}(),function(){"use strict";angular.module("iqfy").controller("OfferingDatesModalController",["$scope","$uibModalInstance","$i18next","$resource","OfferingsDataService","toastr","offering",function(e,r,s,i,a,t,n){e.offering=n,e.isManageUser=!1,e.isActivationMode=!1,e.offeringDatesValidation={},e.portfolio=null,a.getPortfolio(n.content_id,function(r){e.playlist=r.modules||[],e.portfolio=r}),e.updateOfferingDates=function(e,r){r.validation&&(e.offeringDatesValidation.hasError=!r.validation.isValid),r.offeringStartDate&&(e.offering.start=r.offeringStartDate),r.offeringEndDate&&(e.offering.end=r.offeringEndDate),e.offering.dates=e.offering.dates||{},e.offering.dates.modules=e.offering.dates.modules||{},e.offering.dates.tasks=e.offering.dates.tasks||{},r.sectionDates&&(e.offering.dates.modules=r.sectionDates),r.taskDates&&(e.offering.dates.tasks=r.taskDates)},e.save=function(){var a={offeringid:e.offering.id,offeringData:{start:e.offering.start,end:e.offering.end,useRelativeDates:e.offering.useRelativeDates,dates:e.offering.dates}};i("/offerings/:offeringid/",a,{update:{method:"PUT"}}).update(a,function(){t.success(s.t("UpdatedOffering")),r.close({updated:!0})},function(){t.error(s.t("SomethingWentWrong")),r.close()})},e.cancel=function(){r.close()}}])}(),function(){"use strict";function e(e,r){return e("/learner-data-api/submissions/:offeringid/:userid/assignments/:assignmentid/mark",{offeringid:r.id,userid:"@userid",assignmentid:"@assignmentid"})}angular.module("iqfy").factory("FacilitatorAssignmentMarkAPI",e),e.$inject=["$resource","offering"]}(),function(){"use strict";function e(e,r){return e("/api/v1/evaluator/:offeringid/:userid/assignments/:assignmentid/mark",{offeringid:r.id,userid:"@userid",assignmentid:"@assignmentid"})}angular.module("iqfy").factory("EvaluatorAssignmentMarkAPI",e),e.$inject=["$resource","offering"]}(),function(){"use strict";function e(e,r){return e("/api/v1/marker/:offeringid/:userid/assignments/:assignmentid/mark",{offeringid:r.id,userid:"@userid",assignmentid:"@assignmentid"})}function r(e,r){return e("/api/v1/marker/:offeringid/:userid/assignments/:assignmentid/mark/:markid/feedback",{offeringid:r.id,userid:"@userid",assignmentid:"@assignmentid"})}function s(e,r){return e("/api/v1/marker/:offeringid/:userid/assignments/:assignmentid/mark/:markid/feedbackByFacilitator",{offeringid:r.id,userid:"@userid",assignmentid:"@assignmentid"})}angular.module("iqfy").factory("MarkerAssignmentMarkAPI",e),e.$inject=["$resource","offering"],angular.module("iqfy").factory("MarkerAssignmentFeedbackAPI",r),r.$inject=["$resource","offering"],angular.module("iqfy").factory("FacilitatorAssignmentFeedbackAPI",s),s.$inject=["$resource","offering"]}(),function(){"use strict";var e=angular.module("iqfy");e.service("SubmissionsService",["UserService","ContentService","$window","iqfy","GroupAssessmentAPI","$i18next","toastr",function(e,r,s,i,a,t,n){return{getAssessmentMapping:function(e){return-1!==["upload","video","external","externalProvider","openResponse"].indexOf(e.type)?"assignments":-1!==["summative_quiz","quiz"].indexOf(e.type)?"quizzes":"practice_quizzes"},getUserSubmission:function(e,r){if(r){var s=this.getAssessmentMapping(r),i=r.$id;if(this.submissions&&this.submissions[e]&&this.submissions[e][s]){if("assignments"==s&&this.submissions[e][s][i])return this.submissions[e][s][i];if("quizzes"==s||"practice_quizzes"==s){var a=r.pid,t=r.$id;if(this.submissions[e][s][a]&&this.submissions[e][s][a][t])return this.submissions[e][s][a][t];if(!_.isEmpty(this.submissions[e][s][a]))return t=_.keys(this.submissions[e][s][a])[0],this.submissions[e][s][a][t]}}}},viewAssessment:function(e,r,s,a){e.modals={},e.modals[r.$id]=!0,e.currentAssessment=r,e.currentUserId=s.uid,e.currentSubmission=this.getUserSubmission(s.uid,r),e.currentLearner=s,e.showGrantExtensionForm=!1,e.format="EEEE, dd MMM yyyy HH:mm:ss";var t=(i.orgSettings.locale,i.orgSettings.timezone);if(e.currentSubmission&&e.currentSubmission.submittedAt&&(e.currentSubmission.submittedAtInOrgTimezone=moment(e.currentSubmission.submittedAt).tz(t).format("LLLL")),!0===r.groupAssessment&&i&&i.orgSettings&&!0===i.orgSettings.groupAssessmentsEnabled&&this.getGroupMembers(e,s.uid),e.markers={},e.markers=this.getMarkers(e.currentSubmission,e),a)return a()},getDueDate:function(e,s){var i=r.offering.id;return s.extensions&&s.extensions[i]&&s.extensions[i][e.pid]&&s.extensions[i][e.pid][e.id]?s.extensions[i][e.pid][e.id]:e.dueDate||e.due_date||""},getGroupMembers:function(e,r){a.query({userid:r},function(r){e.groupMembers=r})},getMarkers:function(r,s){if(s.markers=s.markers||{},r){var i=_.extend({},r.marks);_.each(r.archivedMarks,function(e){_.each(e,function(e){e.isArchived=!0}),i=_.extend(i,e)});var a=_(i).map("markerId").uniq().value(),t=e._details.uid;s.currentLearner&&this.canSubmitMark(r,s,s.currentLearner.uid)&&(a=_.without(a,t),a.unshift(t)),_.each(a,function(r){s.markers[r]={markerId:r,markedBy:r==e._details.uid?e._details.first+" "+e._details.last:_(i).sortBy("createdAt").reverse().find({markerId:r}).markedBy,marks:_.pickBy(i,function(e,s){return e.markId=s,e.markerId==r}),currentMark:_.pickBy(i,function(e,s){return e.markId=s,e.markerId==r&&!e.isArchived})}})}return s.markers},getFormattedMark:function(r,s){var i=this.getAssessmentMapping(s),a=this.getUserSubmission(r,s);e._details.uid;if("assignments"==i&&a&&a.latestMark){return a.latestMark.files&&a.latestMark.files.length?"Contain marked files":a.latestMark.mark||a.latestMark.feedback}},getMarkFeedback:function(r,s){var i=e._details.uid,a=this.getUserSubmission(r,s)||{},t=_(a.marks).map("markerId").uniq().value(),n=!1,o=!1;return _(t).forEach(function(e){e===i&&(n=!0)}),n&&_.forEach(a.marks,function(e){e.markerId===i&&e.markFeedback&&(o=!0)}),o},assessmentState:function(r,s){if(s){var a,t={upload:{open:"started",submitted:"submitted"}},n={},o=this.getFormattedMark(r,s),u=this.getUserSubmission(r,s);if(-1!==["upload","openResponse","externalProvider"].indexOf(s.type)){a=!!o;var c=(u||{}).status,d=t.upload[c]||"not-started";if(n={marked:a,overdue:s.pastDueDate&&!a},n[d]=!0,i.orgSettings&&i.orgSettings.allowIqfyAssess){var l=this.getMarkFeedback(r,s),f=e._details.uid,m=!1;if(u){var g=_(u.marks).map("markerId").uniq().value();_(g).forEach(function(e){e===f&&(m=!0)})}f!==r&&(a||"submitted"!==c?a&&l?n["marked-icon"]=!0:a&&!m&&(n["marked-icon"]=!0):n["marking-required"]=!0)}}return n}},canSubmitMark:function(e,r){return e&&"submitted"===e.status},submitMark:function(e,r,s,i){var a=this,o=this.newMark;o.revision=s.marks?Object.keys(s.marks).length:0;var u={mark:o,source_page:"progress-overview"};a.savingMark=!0,this.assignmentMarkAPI.save({userid:i,assignmentid:r.$id},u,function(i){a.newMark={},a.savingMark=!1,a.amendMark.enabled=!1,s.marks=s.marks||[],s.marks[i.markId]=i,s.latestMark=i;var u=o.files&&o.files.length;r.formattedMark=u?"Contain marked files":o.mark||o.feedback,e.markers=a.getMarkers(s,e),n.success(t.t("MarkAdded"))},function(){a.savingMark=!1})},canAmendMark:function(r,s,i,a){if(!_.size(r.marks))return!1;var t=!!i&&!!_(r.marks).filter({markerId:i}).size();return this.canSubmitMark(r,s,a)&&i==e._details.uid&&t},hasUnmarkedAssessmentItem:function(e,r){var s=!0,i=this;return _.each(r,function(r){i.assessmentState(e,r).marked||(s=!1)}),s},getAddFileBtnLabel:function(){return this.newMark&&this.newMark.files?"Add "+(_.size(this.newMark.files)?"another":"")+" file":"Add file"},onUploadMarkingFile:function(e,r){if(e&&e.filesUploaded&&e.filesUploaded[0]){var i=this,a=e.filesUploaded,t=(new Date).getTime();r.$apply(function(){var e={};_.each(a,function(r){var i=s.generatePushID();r.createdAt=t,r.filepickerUrl=r.url,r.url="/assets/fp-resources/"+r.handle,e[i]=r}),i.newMark.files=i.newMark.files||{},angular.extend(i.newMark.files,e)})}},onDeleteMarkingFile:function(e){this.newMark.files=this.newMark.files||{};var r=_.findKey(this.newMark.files,{key:e});r&&delete this.newMark.files[r]}}}])}(),function(){"use strict";angular.module("iqfy").service("FacilitatorSubmissionsService",["offering","guest","iqfy","SubmissionsService","FacilitatorDashboardQuizAttemptAPI","FacilitatorDashboardAssignmentSubmissionAPI","FacilitatorAssignmentMarkAPI","FacilitatorAssignmentFeedbackAPI","$timeout","$window","$rootScope","$i18next","toastr",function(e,r,s,i,a,t,n,o,u,c,d,l,f){var m=_.extend({},i,{submissions:{},amendMark:{enabled:!1},newMark:{},getFormattedMark:function(e,r){var s=this.getAssessmentMapping(r),i=this.getUserSubmission(e,r);return"assignments"==s&&i&&i.latestMark?i.latestMark.files&&i.latestMark.files.length?"Contain marked files":"binary"===r.markingScheme?i.latestMark.mark?"Yes"===i.latestMark.mark?"Completed":"Not Completed":i.latestMark.feedback:i.latestMark.mark||i.latestMark.feedback:("practice_quizzes"==s||"quizzes"==s)&&i&&i.attempts&&void 0!==i.attempts.latestMarkPercent?i.attempts.latestMarkPercent.toString():void 0},assessmentState:function(e,r){if(r){var i,a={upload:{open:"started",submitted:"submitted"}},t={},n=this.getFormattedMark(e,r),o=this.getUserSubmission(e,r),u="practice_quiz"==r.type||o&&r.maxAttempts>o.attemptCount&&r.pastOpenDate&&!r.pastDueDate;if(-1!==["upload","video","openResponse","externalProvider"].indexOf(r.type)){i=!!n;var d=(o||{}).status,l=a.upload[d]||"not-started";t={marked:i,overdue:r.pastDueDate&&!i},t[l]=!0}else if("summative_quiz"===r.type){i=void 0!==n,t={marked:i,overdue:r.pastDueDate&&!i,"attempts-remaining":!!u};var f=i;f?t.submitted=!0:t["not-started"]=!0}else"practice_quiz"===r.type&&(t.submitted=o&&_.size(o.attempts));if(s.orgSettings&&s.orgSettings.allowIqfyAssess){var m=c.userId,g=!1;if(o){var k=_(o.marks).map("markerId").uniq().value();_(k).forEach(function(e){e===m&&(g=!0)})}m!==e&&(i||"submitted"!==d?i&&!g&&(t["marked-icon"]=!0):t["marking-required"]=!0)}return t}},getModalTitleLink:function(r,s){return s.guestMode?"":"upload"==r.type||"externalProvider"==r.type||"openResponse"==r.type||"video"==r.type?"/course/"+e.id+"/assessments/"+r.$id:"summative_quiz"==r.type||"practice_quiz"==r.type?r.pid?"/course/"+e.id+"/"+r.pid:r.url:void 0},canDownloadAttempt:function(e,r){return e.attemptStatus&&"started"!=e.attemptStatus&&(!0===r.facilitatorDashboardMode||!0===r.feedbackMarkingMode)},canSeeAttemptReport:function(e,r){return 1!=e.markPercent&&1==r.learnerMode&&!0!==r.facilitatorDashboardMode&&!0!==r.feedbackMarkingMode},resetAttempt:function(e,r,s){var i=this;window.confirm("Are you sure you want to delete this attempt?")&&(i.isLoading=!0,a.delete({userid:r,quizid:e,attemptid:s},function(){i.isLoading=!1,setTimeout(function(){window.location.reload(!0)},300)}))},canSubmitMark:function(e,r){return this.canReopenSubmission(e,r)},canReopenSubmission:function(e,r){return e=e||{},"submitted"===e.status&&(!0===r.facilitatorDashboardMode||!0===r.feedbackMarkingMode)},reOpenSubmission:function(e,r){window.confirm("Are you sure you want to re-open submission for this assessment? Any marks that have previously been awarded for it will be removed, and it will need to be re-submitted by the learner(s) in order to be marked again.")&&t.delete({userid:e,assessmentid:r.$id},function(){setTimeout(function(){window.location.reload(!0)},300)})},submitMark:function(e,r,s,i){var a=this,t=this.newMark;t.revision=s.marks?Object.keys(s.marks).length:0;var o={mark:t,source_page:"facilitatorDashboardIndex"==e.ctrlName?"progress-overview":"learner-progress"};a.savingMark=!0,n.save({userid:i,assignmentid:r.$id},o,function(i){a.newMark={},a.savingMark=!1,a.amendMark.enabled=!1,s.marks=s.marks||{},s.marks[i.markId]=i,s.latestMark=i;var n=t.files&&t.files.length;r.formattedMark=n?"Contain marked files":t.mark||t.feedback,e.markers=a.getMarkers(s,e),f.success(l.t("FeedbackAdded")),r.groupAssessment&&(f.info(l.t("PageWillRefresh")),u(function(){c.location.reload(!0)},500))},function(){a.savingMark=!1})},sendEvaluationFeedback:function(e,r,s,i){var a=this,t=this.newMarkerEval;if(t&&(t.mark||t.feedback)){var n={mark:t,evaluatingLearnerId:i};a.savingMarkerEval=!0,o.save({userid:s,assignmentid:e.$id,markid:r.markId},n,function(e){a.newMarkerEval={},a.savingMarkerEval=!1,r.markFeedback=r.markFeedback||{},r.markFeedback[e.markFeedbackId]=e,a.showAmendFeedbackForMark=!1,f.success(l.t("FeedbackAdded"))},function(e){e&&e.data&&(a.feedbackFormErrorMessage=e.data),a.savingMarkerEval=!1})}},resetMark:function(){this.amendMark.enabled=!1,this.newMark={}}});return d.$on("modalClosed",function(e,r){m.newMark={},m.savingMark=!1,m.amendMark.enabled=!1,m.showAmendFeedbackForMark=!1,d.$digest()}),m}])}(),function(){"use strict";angular.module("iqfy").service("EvaluatorSubmissionsService",["MixpanelHelper","SubmissionsService","EvaluatorAssignmentMarkAPI","UserService","offering","$rootScope",function(e,r,s,i,a,t){var n=_.extend({},r,{submissions:{},amendMark:{enabled:!1},newMark:{},assignmentMarkAPI:s});return t.$on("modalClosed",function(e,r){n.newMark={},n.savingMark=!1,n.amendMark.enabled=!1,t.$digest()}),n}])}(),function(){"use strict";angular.module("iqfy").service("MarkerSubmissionsService",["MixpanelHelper","SubmissionsService","MarkerAssignmentMarkAPI","MarkerAssignmentFeedbackAPI","ContentService","offering","$rootScope","$i18next","toastr",function(e,r,s,i,a,t,n,o,u){var c=_.extend({},r,{submissions:{},amendMark:{enabled:!1},newMark:{},assignmentMarkAPI:s,feedbackFormErrorMessage:"",canSubmitMark:function(e,r,s){return e&&"submitted"===e.status&&a.isMarkerOfUser(s)},sendEvaluationFeedback:function(e,r,s,a){var t=this,n=this.newMarkerEval;if(n&&(n.mark||n.feedback)){var c={mark:n,evaluatingLearnerId:a};t.savingMarkerEval=!0,i.save({userid:s,
assignmentid:e.$id,markid:r.markId},c,function(e){t.newMarkerEval={},t.savingMarkerEval=!1,r.markFeedback=r.markFeedback||{},r.markFeedback[e.markFeedbackId]=e,t.showAmendFeedbackForMark=!1,u.success(o.t("FeedbackAdded"))},function(e){e&&e.data&&(t.feedbackFormErrorMessage=e.data),t.savingMarkerEval=!1})}}});return n.$on("modalClosed",function(e,r){c.newMark={},c.savingMark=!1,c.amendMark.enabled=!1,c.showAmendFeedbackForMark=!1,n.$digest()}),c}])}(),angular.module("iqfy").factory("FacilitatorDashboardAssignmentSubmissionAPI",["$resource","offering",function(e,r){return e("/learner-data-api/submissions/:offeringid/:userid/assignments/:assessmentid",{offeringid:r.id,userid:"@userid",assessmentid:"@assessmentid"})}]).factory("FacilitatorDashboardUserAPI",["$resource","offering",function(e,r){return e("/learner-data-api/offerings/:offeringid/learners/:learnerid/:info/:token",{offeringid:r.id,learnerid:"@learnerid",info:"@info",token:"@token"})}]).factory("FacilitatorDashboardUserSubmissionsAPI",["$resource","offering",function(e,r){return e("/learner-data-api/submissions/:offeringid/:learnerid/:token",{offeringid:r.id,learnerid:"@learnerid",token:"@token"})}]).factory("FacilitatorDashboardOfferingSubmissionsAPI",["$resource","offering",function(e,r){return e("/learner-data-api/submissions/:offeringid/",{offeringid:r.id})}]).factory("FacilitatorDashboardQuizAttemptAPI",["$resource","offering",function(e,r){return e("/learner-data-api/submissions/:offeringid/:userid/quizzes/:quizid/:attemptid",{offeringid:r.id,userid:"@userid",quizid:"@quizid",attemptid:"@attemptid"})}]).factory("GroupAssessmentAPI",["$resource","offering",function(e,r){return e("/api/v1/assessmentgroups/:offeringid/:userid",{offeringid:r.id,userid:"@userid"})}]).factory("EvaluatorAPI",["$resource","offering",function(e,r){return e("/api/v1/evaluator/:offeringid/:action",{offeringid:r.id})}]).factory("MarkerAPI",["$resource","offering",function(e,r){return e("/api/v1/marker/:offeringid/:action",{offeringid:r.id})}]);