!function(e){function t(t,r){var n=this;n.el=t,n.$el=e(t),n.options=e.extend({},s,r),n.terms=[],n.excludes=[],n.replaced=[],n.regexOption=n.options.replaceOnce?"i":"ig",getJSON=function(){return new Promise(function(t,r){return i[n.options.sourceURL]?t(i[n.options.sourceURL]):o[n.options.sourceURL]?void window.setTimeout(function(){return getJSON().then(t,r)},100):(o[n.options.sourceURL]=!0,void e.getJSON(n.options.sourceURL).then(function(e){return i[n.options.sourceURL]=e,o[n.options.sourceURL]=!1,t(i[n.options.sourceURL])},r))})},getJSON().then(function(e){if(n.glossary=e,n.glossary.length&&0!=n.glossary.length){for(var t=0;t<n.glossary.length;t++)for(var r=n.glossary[t].term.split(","),s=0;s<r.length;s++){var i=r[s].replace(/^\s+|\s+$/g,""),o=i.indexOf("!");-1==o||0!=o?n.terms.push(i):n.excludes.push(i.substr(1))}n.terms.sort(function(e,t){return t.length-e.length}),n.wrapTerms()}})}function r(t,r,s){if("string"!=typeof t)return e.inArray.apply(this,arguments);if(r){var i=r.length;for(s=s?s<0?Math.max(0,i+s):s:0,t=t.toLowerCase();s<i;s++)if(s in r&&r[s].toLowerCase()==t)return s}return-1}var s={sourceURL:"",replaceTag:"abbr",lookupTagName:"p, ul, a, div",callback:null,replaceOnce:!1,replaceClass:"glossarizer_replaced"},i=[],o=[];t.prototype={getDescription:function(e){for(var t=(new RegExp("(^s*)"+this.clean(e)+"\\s*|\\,$","i"),0);t<this.glossary.length;t++)if(this.glossary[t].term.indexOf(",")>-1){for(var r=this.glossary[t].term.split(","),s=0;s<r.length;s++)if(r[s]=r[s].trim().toLowerCase(),r[s]==this.clean(e).toLowerCase())return this.glossary[t].description.replace(/\"/gi,"&quot;")}else if(this.glossary[t].term.toLowerCase()==e.toLowerCase())return this.glossary[t].description.replace(/\"/gi,"&quot;")},clean:function(e){var t=new RegExp("(\\"+["/",".","*","+","?","(",")","[","]","{","}","\\"].join("|\\")+")","g");return e.replace(t,"\\$1")},wrapTerms:function(){var e="\\\\[\\[\\(].+?(?=\\\\[\\]\\)])\\\\[\\]\\)]";this.excludes.push(e),this.cleanedTerms=this.clean(this.terms.join("|")),this.excludedTerms=this.clean(this.excludes.join("|")),this.excludedTerms+=void 0===this.excludedTerms?"":"|",this.excludedTerms+=e;for(var t=this.el.querySelectorAll(this.options.lookupTagName),r=0;r<t.length;r++)this.traverser(t[r]);this.options.callback&&this.options.callback.call(this.$el)},traverser:function(t){var s,i=this;if(1===t.nodeType){if(t=t.firstChild)do{s=t.nextSibling,t.className!=this.options.replaceClass&&this.traverser(t)}while(t=s)}else if(3===t.nodeType){var o=document.createElement("div"),n=t.data,a=new RegExp("(?:^|\\b)("+this.cleanedTerms+")(?!\\w)",i.regexOption),l=new RegExp("("+this.excludedTerms+")",i.regexOption);if(n=n.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),a.test(n)){var c=l.exec(n);for(n=n.replace(a,function(e,t,s,o){if(i.options.replaceOnce&&r(e,i.replaced)>=0)return e;if(i.replaced.push(e),new RegExp("(?:^|\\b)"+i.clean(e)+"(?!\\w)").exec(n)){if(c&&i.excludes.length){var a=s,l=c.index,p=c.index+c[0].length;return l<=a&&a<=p?e:"<"+i.options.replaceTag+' class="'+i.options.replaceClass+'" title="'+i.getDescription(e)+'">'+e+"</"+i.options.replaceTag+">"}return"<"+i.options.replaceTag+' class="'+i.options.replaceClass+'" title="'+i.getDescription(e)+'">'+e+"</"+i.options.replaceTag+">"}}),e(o).html(n);o.firstChild;)t.parentNode.insertBefore(o.firstChild,t);t.parentNode.removeChild(t)}}}};var n={destroy:function(){this.$el.removeData("plugin_glossarizer"),this.$el.find("."+this.options.replaceClass).each(function(){var t=e(this),r=t.text();t.replaceWith(r)})}};t.prototype=e.extend({},t.prototype,n),e.fn.glossarizer=function(r){return this.each(function(){var s=e(this),i=s.data("plugin_glossarizer");"string"==typeof r&&i&&n.hasOwnProperty(r)?i[r].apply(i):(i&&i.destroy.apply(i),e.data(this,"plugin_glossarizer",new t(this,r)))})}}(jQuery);