!function(){"use strict";angular.module("iqfy").value("AssessmentPage",{offeringId:window.offeringId}).controller("AssignmentFileUploadController",["$scope","$rootScope","$routeParams","$resource","$timeout","_","toastr","fileUploadService","AssignmentUploadFilePickerFactory","AssignmentUploadVideoFactory","AssessmentPage","$window","iqfy","$route","submitUploadAssignment","removeAssignmentFile","removeAssignmentVideo","saveOpenResponse","$i18next",function(e,s,n,i,o,t,a,r,d,m,l,p,u,f,g,c,v,S,A){e.isLoading=!1,e.uploadCompleted=!1,e.newVideoAssessment=!1,e.assignmentid=n.assignmentid,e.isValidToSubmitOpenResponse=!1,e.isSubmitting=!1,e.timezone="Pacific/Auckland",u&&u.orgSettings&&u.orgSettings.timezone&&(e.timezone=u.orgSettings.timezone);var b={};window.iqfyAssignmentFilePicker?b=window.iqfyAssignmentFilePicker:u.orgSettings&&u.orgSettings.filepicker&&(b=u.orgSettings.filepicker.assignments);var R=t.findEnabledKeys(b.services);e.assessmentUploadServices=t.size(R)?r.mapServicesToSources(R):r.defaultServices;var y=t.map(t.findEnabledKeys(b.extensions),function(e){return"."+e});e.assessmentUploadMimetypes=t.size(y)?y:r.defaultAssessmentMinetypes,e.simpleUploadAcceptedTypes=e.assessmentUploadMimetypes.join(",");var U=b.maxSize||50;e.assessmentUploadMaxSize=1024*U*1024,e.onUploadAssessment=function(s){function i(){t.every(r)?($("html, body").animate({scrollTop:$("#files").offset().top-80},500),a.success(A.t("UploadCompleted")),e.uploadCompleted=!0):a.error(A.t("SomethingWentWrongTryUploadingAgain")),e.isLoading=!1}if(e.isLoading=!0,!s||!s.filesUploaded||!s.filesUploaded[0])return e.isLoading=!1,void(e.uploadCompleted=!1);var o=s.filesUploaded,r=[],m=0;t.each(o,function(s){if(s.size>e.assessmentUploadMaxSize)return void a.error(A.t("UploadFileExceededTheMaximumAllowedSize"));var t={offeringid:l.offeringId,assessmentid:l.assessmentId||n.assignmentid},p={assessmentData:{filename:s.filename,container:s.container,handle:s.handle,key:s.key,blobname:s.key,ext:s.mimetype,size:s.size,url:s.url}};d.save(t,p,function(){e.$parent.$parent.$broadcast("file-added",{filename:s.filename,size:s.size,createdAt:new Date}),r.push(!0),++m==o.length&&i()},function(){r.push(!1),++m==o.length&&i()})})},e.onUpdateVideoAssessment=function(i,t){if(i){var r={offeringid:l.offeringId,assessmentid:l.assessmentId||n.assignmentid},d={assessmentData:i};t&&(d.assessmentvideoid=t),m.save(r,d,function(n){n.err?(a.error(n.message||A.t("AssessmentAlreadySubmitted")),e.isLoading=!1,o(f.reload(),1e3)):(s.$broadcast("video-added",{url:i.url,urlStandardized:i.urlStandardized,originalFilename:i.originalFilename,azureBlobFilename:i.azureBlobFilename,posterImgUrl:i.posterImgUrl,transcriptHtml:i.transcriptHtml,videoType:i.videoType,createdAt:new Date}),$("html, body").animate({scrollTop:$("#videos").offset().top-80},500),a.success(A.t("UploadCompleted")),e.isLoading=!1,e.uploadCompleted=!0,e.newVideoAssessment=!1)},function(){a.error(A.t("SomethingWentWrongTryUploadingAgain")),e.isLoading=!1})}},e.onCancelVideoAssessment=function(){e.newVideoAssessment=!1},e.onRemoveVideoAssessment=function(n,i){i&&""!==i&&v.save({offeringId:l.offeringId,assessmentid:e.assignmentid,videoid:i},function(){s.$broadcast("video-removed",i),a.success(A.t("FileRemoved"))},function(){a.error(A.t("FileCantRemovedTryAgain"))}),e.newVideoAssessment=!1},e.onNewVideoAssessment=function(){e.newVideoAssessment=!0},e.removeFile=function(n){e.isLoading=!0,c.save({offeringId:l.offeringId,assessmentid:e.assignmentid,fileid:n},function(){e.isLoading=!1,s.$broadcast("file-removed",n),a.success(A.t("FileRemoved"))},function(){e.isLoading=!1,a.error(A.t("FileCantRemovedTryAgain"))})},e.submitAssignment=function(){e.isSubmitting=!0,g.save({offeringId:l.offeringId,assessmentid:e.assignmentid},function(n){if(e.isSubmitting=!1,n.err)return a.error(n.message||A.t("AssignmentNotSubmitted")),void o(f.reload(),1e3);s.$broadcast("assignment-submitted",n),a.success(A.t("AssignmentSubmitted"))},function(){e.isSubmitting=!1,a.error(A.t("AssignmentNotSubmitted"))})},e.addOpenResponseFile=function(s){if(!s||!s.filesUploaded||!s.filesUploaded[0])return e.isLoading=!1,void(e.uploadCompleted=!1);t.each(s.filesUploaded,function(s){e.$parent.assignment.openResponseFiles.push(s)})},e.removeOpenResponseFile=function(s){e.$parent.assignment.openResponseFiles.splice(s,1)},e.saveOpenResponse=function(s){var n="";if(!(n=$.fn.redactor?angular.element("#openResponseData").val():angular.element("#openResponseData").redactor("code.get"))&&t.isEmpty(e.$parent.assignment.openResponseFiles))return void(e.isValidToSubmitOpenResponse=!0);var i={offeringId:l.offeringId,assessmentid:e.assignmentid,action:s},o={openResponseData:n||" ",openResponseFiles:e.$parent.assignment.openResponseFiles||[]};e.savingOpenResponse=!0,e.openResponseSubmissionError=null;var r;S.save(i,o,function(){r=A.t("Response")+" "+("draft"==s?A.t("Saved").toLowerCase():A.t("Submitted").toLowerCase()),a.success(r),e.savingOpenResponse=!1,f.reload()},function(n){if(e.savingOpenResponse=!1,e.contentService.readOnlyOffering)return e.isValidToSubmitOpenResponse=!1,void a.error(A.t("ResponseNotSavedInReadOnlyMode"));n=n||{},n.data=n.data||{},r="draft"==s?A.t("ResponseNotSaved."):A.t("ResponseNotSubmitted."),a.error(r);var i=function(e){return n.data.errorCode&&n.data.errorCode===e};return i("userNotInGroupError")?void(e.openResponseSubmissionError=n.data.err):i("errEmptySubmission")?void(e.openResponseSubmissionError=n.data.err):i("errSubmissionIsAlreadySubmitted")?void(e.openResponseSubmissionError=n.data.err):void 0})}}])}();